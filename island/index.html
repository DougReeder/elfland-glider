<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Island - Elfland Glider</title>
    <meta name="description" content="Help the fairies collect all their stars!">
    <meta http-equiv="origin-trial" data-feature="WebVR (For Chrome M62+)" data-expires="2018-04-11" content="Al6l70dATrKRflEm0SAge/ZJPjuCVgt63u0547V2ATUA0ltvfkXkXWfmuMs4Q5PLf75XLXDQYq2fCGE1sbXUQw8AAABZeyJvcmlnaW4iOiJodHRwczovL2RvdWdyZWVkZXIuZ2l0aHViLmlvOjQ0MyIsImZlYXR1cmUiOiJXZWJWUjEuMU02MiIsImV4cGlyeSI6MTUyMzQyNTQwNn0=">
    <script src="https://rawgit.com/aframevr/aframe/6019885/dist/aframe-master.min.js"></script>
    <script src="https://unpkg.com/aframe-state-component/dist/aframe-state-component.min.js"></script>
    <script src="../assets/state.js"></script>
    <script src="https://cdn.rawgit.com/DougReeder/aframe-simple-sun-sky/6cff915e/simple-sun-sky.js"></script>
    <script src="https://unpkg.com/aframe-aabb-collider-component/dist/aframe-aabb-collider-component.min.js"></script>

    <script src="../assets/stella-octangula.js"></script>
    <script src="https://unpkg.com/aframe-glow@^1.0.1/dist/aframe-glow-component.min.js"></script>
    <script src="../assets/ImprovedNoise.js"></script>
    <script src="../assets/aframe-mountain-component.js"></script>
    <script>
        AFRAME.registerComponent('island', {
            init: function () {
                let sceneEl = this.el;
                sceneEl.emit('setState', {gliderPositionStart: {x:-500, y:100, z:500}});
                sceneEl.emit('setState', {gliderPosition: {x:-500, y:100, z:500}});

                let mountainEl = sceneEl.querySelector('a-mountain');
                let mountainComp = mountainEl.components.mountain;

                for (let p=0; p<6; ++p) {
                    let powerupEl = document.createElement('a-entity');
                    powerupEl.setAttribute('class', 'powerup');
                    let dispersion = 1000;
                    let ceiling = p < 1 ? 15 : 100;   // keep one powerup low
                    powerupEl.setAttribute('position', this.randomPosition(mountainComp, dispersion, 9, ceiling));
                    powerupEl.setAttribute('geometry', {primitive:'triangle', vertexA:'-1.5 -1.5 -1.5', vertexB:'1.5 -1.5 1.5', vertexC:'1.5 1.5 -1.5'});
                    powerupEl.setAttribute('material', {visible:false});
                    powerupEl.setAttribute('sound', {src:'#powerup', volume:'4.0', on:'hitstart'});

                    let powerupInnerEl = document.createElement('a-icosahedron');
                    powerupInnerEl.setAttribute('material', {color:'#ff0000'});
                    powerupInnerEl.setAttribute('glow', {c: '0.2', color: '#ff0000', scale:'3.5'});

                    powerupEl.appendChild(powerupInnerEl);
                    sceneEl.appendChild(powerupEl);
                }


                let totalStars = AFRAME.utils.device.isMobile() ? 50 : 75;
                for (let s=0; s<totalStars; ++s) {
                    let starEl = document.createElement('a-entity');
                    starEl.setAttribute('class', 'star');
                    let dispersion = s < 3 ? 1750 : 1000;   // place a couple stars away from the island
                    starEl.setAttribute('position', this.randomPosition(mountainComp, dispersion, 12, 150));
                    starEl.setAttribute('geometry', {primitive:'triangle', vertexA:'-1.5 -1.5 -1.5', vertexB:'1.5 -1.5 1.5', vertexC:'1.5 1.5 -1.5'});
                    starEl.setAttribute('material', {visible:false});
                    starEl.setAttribute('sound', {src:'#ding', on:'hitstart'});

                    let starInnerEl = document.createElement('a-entity');
                    starInnerEl.setAttribute('rotation', '45 0 45');
                    starInnerEl.setAttribute('geometry', {primitive: 'stella-octangula'});
                    starInnerEl.setAttribute('material', {color:'#ffce00'});
                    starInnerEl.setAttribute('glow', {c: '0.2', color: '#feca05', scale:'3.5'});

                    starEl.appendChild(starInnerEl);
                    sceneEl.appendChild(starEl);
                }

                sceneEl.emit('countYellowStars', {});

                let portalEl = document.getElementById('nextQuestPortal');
                portalEl.setAttribute('position', this.randomPosition(mountainComp, 1000, 12, 100));

                let fairiesEl = document.createElement('a-gltf-model');
                fairiesEl.setAttribute('position', this.randomPosition(mountainComp, 750, 50, 100));
                fairiesEl.setAttribute('src', '#fairies');
                fairiesEl.setAttribute('scale', '0.5 0.5 0.5');
                sceneEl.appendChild(fairiesEl);

                if (!AFRAME.utils.device.isMobile()) {
                    // These decorations do not need to be pre-loaded via the asset mgr
                    let floatingEl = document.createElement('a-gltf-model');
                    floatingEl.setAttribute('position', this.randomPosition(mountainComp, 750, 50, 100));
                    floatingEl.setAttribute('src', '../assets/hermit_s_windmill/scene.gltf');
                    floatingEl.setAttribute('scale', '0.01 0.01 0.01');
                    sceneEl.appendChild(floatingEl);

                    let buildingEl = document.createElement('a-gltf-model');
                    buildingEl.setAttribute('position', mountainComp.buildingPosition());
                    buildingEl.setAttribute('src', '../assets/stabbur/scene.gltf');
                    buildingEl.setAttribute('scale', '3 3 3');
                    buildingEl.setAttribute('class', 'landscape');
                    sceneEl.appendChild(buildingEl);
                }
            },

            randomPosition: function (mountainComp, dispersion, verticalOffset, ceiling) {
                let x, y, z;
                do {
                    x = (Math.random() - 0.5) * dispersion;
                    z = (Math.random() - 0.5) * dispersion;
                    y = mountainComp.height(x, z) + verticalOffset;
                } while (y > ceiling);
                return x + ' ' + y + ' ' + z;
            }
        });
    </script>

    <!--<script src="https://unpkg.com/aframe-fps-counter-component/dist/aframe-fps-counter-component.min.js"></script>-->
</head>
<body>
<a-scene island cursor="rayOrigin: mouse">
    <a-assets>
        <audio id="ding" src="../assets/393633__daronoxus__ding.mp3"></audio>
        <audio id="powerup" src="../assets/411460__inspectorj__power-up-bright-a.mp3"></audio>
        <audio id="minimalist" src="../assets/Olaf%20Minimalist.mp3"></audio>
        <a-asset-item id="fairies" src="../assets/bucket_with_fairies/scene.gltf"></a-asset-item>
    </a-assets>

    <a-simple-sun-sky sun-position="1 1 1" dark-color="#0b486b"></a-simple-sun-sky>


    <a-mountain position="0 0 0" scale="1 1 1" world-depth="64" world-width="64" sun-position="1 1 1"
                color="#4DBD33" shadow-color="#395D33" sea-color="#006994" class="landscape"></a-mountain>

    <a-entity geometry="primitive:triangle; vertexA:-500 0 -500; vertexB:7483 0 -500; vertexC:-500 0 -7483"
            material="shader: flat; color:#006994;" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:500 0 -500; vertexB:500 0 7483; vertexC:7483 0 -500"
            material="shader: flat; color:#006994;" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:500 0 500; vertexB:-7483 0 500; vertexC:500 0 7483"
            material="shader: flat; color:#006994;" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:-500 0 500; vertexB:-500 0 -7483; vertexC:-7483 0 500"
            material="shader: flat; color:#006994;" class="landscape"></a-entity>

    <a-entity id="nextQuestPortal" position="0 15 -500" scale="5 5 0"
              link="href:../yggdrasil; title: Next Quest; image:../yggdrasil/screenshot-yggdrasil.png; on:hitstart"
              bind="visible: questComplete"></a-entity>


    <a-entity id="armature" geometry="primitive: box; width: 2; height: 2; depth: 2"
              bind__position="gliderPosition" bind__rotation.y="gliderRotationY" armature-tick-state
              aabb-collider="objects:.powerup,.star,[link]" >
        <a-entity id="glider" position="0 0 0" bind__rotation.x="gliderRotationX"
                  raycaster="objects:.landscape; far:0.5;">
            <a-entity id="headingTriangle" position="0 1.5 0"
                      geometry="primitive:triangle; vertexA:0 0 -4.25; vertexB:0.1 0 0; vertexC:-0.1 0 0;"
                      material="shader: flat; transparent:true; opacity:0.2; color:black;"></a-entity>
        </a-entity>
        <a-entity camera="userHeight: 0" look-controls>
            <a-text id="hud" position="0.2 0.42 -0.75" rotation="30 -20 0" width="2" align="center" value="HUD"
                    geometry="primitive:plane; width:0.14; height:0.1;"
                    material="color: gray; opacity: 0.7" bind__text="value: hudText" bind__visible="hudVisible"></a-text>
        </a-entity>
        <a-entity laser-controls="hand: right"></a-entity>
        <a-text id="prelaunchHelp" position="0 0 -1" rotation="0 0 0" width="2" align="center" font="mozillavr" value="Help the fairies\ncollect all their stars!" visible="true"></a-text>
        <a-sound id="environmentalSound" src="#minimalist" loop="true" volume="0.2"></a-sound>
    </a-entity>

    <!--<a-entity fps-counter></a-entity>-->
</a-scene>
</body>
</html>
<!-- Copyright Â© 2018 by P. Douglas Reeder; Licensed under the GNU GPL-3.0 -->
