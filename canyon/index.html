<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Canyon - Elfland Glider</title>
    <meta name="description" content="Maneuver in cramped spaces">
    <meta http-equiv="origin-trial" data-feature="WebVR (For Chrome M62+)" data-expires="2018-09-03" content="Aiddybwc7zVvFiZqTrDXuFJL1s9sLP/gOwWGgZUi7YL/0Y8ymUot/48VE52QxBDFEtgZeaiI7TAf+ooGEqfIeAUAAABceyJvcmlnaW4iOiJodHRwczovL2VsZmxhbmQtZ2xpZGVyLnN1cmdlLnNoOjQ0MyIsImZlYXR1cmUiOiJXZWJWUjEuMU02MiIsImV4cGlyeSI6MTUzNjAwMzgyN30=">
    <meta http-equiv="origin-trial" data-feature="WebVR (For Chrome M62+)" data-expires="2018-09-03" content="AuCpvlGJPXIU6QHylMWk51vVj/0UFoQcnX6TNpuhrdJLwJm8cfgxvb/8xKyvxNpyBPfniHg/qW2pfvu2O6AK9w8AAABZeyJvcmlnaW4iOiJodHRwczovL2RvdWdyZWVkZXIuZ2l0aHViLmlvOjQ0MyIsImZlYXR1cmUiOiJXZWJWUjEuMU02MiIsImV4cGlyeSI6MTUzNjAwMzgyN30=">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.14/howler.core.min.js"></script>
    <script src="https://rawgit.com/aframevr/aframe/a1a142f/dist/aframe-master.min.js"></script>
    <script src="../assets/look-fly-controls.js"></script>
    <script src="https://cdn.rawgit.com/DougReeder/aframe-button-controls/v1.0.0/aframe-button-controls.js"></script>
    <script src="../assets/elfland-utils.js"></script>
    <script src="https://unpkg.com/aframe-state-component@^3.2.4/dist/aframe-state-component.min.js"></script>
    <script src="../assets/state.js"></script>
    <script src="https://unpkg.com/aframe-simple-sun-sky@^1.2.0/simple-sun-sky.js"></script>
    <script src="https://unpkg.com/aframe-dust-component@^1.0.0/aframe-dust-component.js"></script>
    <script src="https://unpkg.com/aframe-aabb-collider-component@^2.2.1/dist/aframe-aabb-collider-component.min.js"></script>
    <script src="https://rawgit.com/andreasplesch/aframe-faceset-component/master/dist/aframe-faceset-component.min.js"></script>
    <script src="https://rawgit.com/andreasplesch/aframe-heightgrid-component/master/dist/aframe-heightgrid-component.min.js"></script>
    <script src="../assets/land-shader.js"></script>
    <!--<script src="https://unpkg.com/aframe-fps-counter-component/dist/aframe-fps-counter-component.min.js"></script>-->
    <script>
        AFRAME.registerComponent('load-terrain', {
           init: function () {
               let terrainEl = document.getElementById('terrain');

               fetch('terrain-heights.txt').then((response) => {
//                   console.log("terrain-heights.txt:", response);
                   if (response.ok) {
                       return response.text();
                   } else {
                       console.error("terrain-heights:", response);
                       return '0 2 1'
                   }
               }).then((text) => {
//                   console.log("text:", text);
                   terrainEl.setAttribute('heightgrid', 'heights', text );
               });

           }
        });

        AFRAME.registerComponent('canyon', {
            init: function () {
                let sceneEl = this.el;
                sceneEl.emit('setState', {gliderPositionStart: {x:150, y:-5, z:150}});
                sceneEl.emit('setState', {gliderPosition: {x:150, y:-5, z:150}});

                sceneEl.emit('countYellowStars', {});

                this.positionSph = new THREE.Spherical(1, Math.PI/2, 0);
                this.position = new THREE.Vector3();
                this.sss = document.querySelector('a-simple-sun-sky');
                this.terrainEl = document.getElementById('terrain');
            },

            tick: function (time) {
                this.positionSph.phi = Math.PI * (0.25 + 0.2 * Math.sin(Math.PI * (time / 120000 - 0.5)));
                this.positionSph.theta = Math.PI * time / 120000;
                this.position.setFromSpherical(this.positionSph);
                let positionStr = this.position.x + ' ' + this.position.y + ' ' + this.position.z;
                this.sss.setAttribute('sun-position', positionStr);
                this.terrainEl.setAttribute('material', 'sunPosition', positionStr);
            }
        });
    </script>
</head>
<body>
<a-scene load-terrain canyon cursor="rayOrigin: mouse">
    <a-assets>
    </a-assets>

    <a-simple-sun-sky sun-position="-1 1 -1"></a-simple-sun-sky>


    <a-entity id="terrain" material="shader:land; sunPosition:-1 1 -1"
              heightgrid="origin:-600 0 -600; xdimension:13; zdimension:13; xspacing:100; zspacing:100;"
              class="landscape"></a-entity>

    <a-entity geometry="primitive:triangle; vertexA:-600 0 -600; vertexB:7483 0 -600; vertexC:-600 0 -7483"
              material="shader:land;" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:600 0 -600; vertexB:600 0 7483; vertexC:7483 0 -600"
              material="shader:land;" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:600 0 600; vertexB:-7483 0 600; vertexC:600 0 7483"
              material="shader:land;" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:-600 0 600; vertexB:-600 0 -7483; vertexC:-7483 0 600"
              material="shader:land;" class="landscape"></a-entity>

    <!--<a-entity position="-24 15 26" rotation="0 -45 0"-->
              <!--geometry="primitive:triangle; vertexA:0 0 0; vertexB:10 0 0; vertexC:0 10 0"-->
              <!--material="shader:land; colorYin:#63574d; sunPosition:-1 1 1;"></a-entity>-->

    <a-dust num-points="128" dispersion="100" color="white" point-size="2"></a-dust>

    <a-entity id="nextQuestPortal" position="0 -5 -500" scale="5 5 0"
              link="href:../yggdrasil; title: Next Quest; image:../yggdrasil/screenshot-yggdrasil.png; on:hitstart"
              bind="visible: questComplete"></a-entity>

    <!--<a-entity fps-counter="for90fps:false"></a-entity>-->
    <!--<a-text id="debugDisplay" position="0 13 -0.5" rotation="0 15 0" width="30" align="left" value="Message" geometry="primitive:plane; width:10; height:1.4;"-->
            <!--material="color: gray" bind="text.value: stars"></a-text>-->

    <a-entity id="armature" geometry="primitive: box; width: 2; height: 2; depth: 2" material="visible:false"
              bind__position="gliderPosition" bind__rotation.y="gliderRotationY" armature-tick-state
              aabb-collider="objects:.star,[link]" >
        <a-entity id="glider" position="0 0 0" bind__rotation.x="gliderRotationX"
                  raycaster="objects:.landscape; far:0.5;">
            <a-entity id="headingTriangle" position="0 1.5 0"
                      geometry="primitive:triangle; vertexA:0 0 -4.25; vertexB:0.1 0 0; vertexC:-0.1 0 0;"
                      material="shader: flat; transparent:true; opacity:0.2; color:black;"></a-entity>
        </a-entity>
        <a-entity id="body">
            <a-entity camera="" look-fly-controls="">
                <a-text id="hud" position="0.2 0.42 -0.75" rotation="30 -20 0" width="2" align="center" value="HUD"
                        geometry="primitive:plane; width:0.14; height:0.1;"
                        material="color: gray; opacity: 0.7" bind__text="value: hudText" bind__visible="hudVisible"></a-text>
            </a-entity>
        </a-entity>
        <a-entity button-controls></a-entity>
        <a-text id="prelaunchHelp" position="0 0 -1" rotation="0 0 0" width="2" align="center" font="mozillavr" value="" visible="true"></a-text>
    </a-entity>
</a-scene>
</body>
</html>
<!-- Copyright Â© 2018 by P. Douglas Reeder; Licensed under the GNU GPL-3.0 -->
