// canyon-terrain.js - the landscape geometry for a canyon
// Data and code are in one file to avoid asynchronous loading.
// Copyright Â© 2023 Doug Reeder; Licensed under the GNU GPL-3.0
import {toCreasedNormals} from '../src/BufferGeometryUtilsRump';
import ImprovedNoise from '../src/ImprovedNoise';

const X_POINTS = 41;
const Z_POINTS = 67;
const terrainHeights = `
0 0 0  0  0  0  0  0  0  0   0  0  0  0  0  0  0  0  0  0   0  0  0  0  0  0  0  0  0  0   0 0 0 0 0 0 0 0 0 0  0
0 0 0  0  0  0  0  0  0  0   0 -1 -2 -2 -1  5 10 15 20 22  25 27 29 23 20 17 15  5  0  0   0 0 0 0 0 0 0 0 0 0  0
0 0 0  0  0  0  0 -1 -2 -3  -3 -2 10 15 25 30 35 37 41 42  45 47 50 54 59 55 54 49 42  5   0 0 0 0 0 0 0 0 0 0  0
0 0 0  0 -1 -2 -3 -4 -4 -3   5 20 25 31 41 45 49 54 56 58  60 63 65 70 72 78 80 70 45 15   1 0 0 0 0 0 0 0 0 0  0
0 0 0 -1 -2 -3 -4 -5 -4 10  20 25 30 35 43 49 52 60 65 70  72 75 80 88 95 99 99 90 75 35  10 0 0 0 0 0 0 0 0 0  0

0 -1 -2 -3 -4 -5 -6 -5 10 20  25 30 38 40 47 55 61 65 70 75  80 85 90 95 99 99 99 99 85 70  30  1  0  0  0  0 0 0 0 0  0
0 -2 -3 -5 -5 -6 -6  5 20 25  30 35 40 46 50 51 59 62 65 70  75 80 85 90 95 99 99 99 94 81  79 68 59  1  0  0 0 0 0 0  0
0 -2 -4 -6 -6 -7 15 20 25 30  35 40 41 45 47 45 40 30 35 45  50 60 65 75 80 85 90 95 90 87  82 70 69 45  1  0 0 0 0 0  0
0 -2 -4 -5 -6 -7 20 31 42 47  49 48 47 46 40 35 30 15 10 10   5 10 20 45 65 65 70 75 86 84  80 78 71 55 66  5 0 0 0 0  0
0 -1 -3 -4 -5 -6 22 39 41 50  52 50 46 41 35 20 10  1  0  0   0  0  0  5 15 40 50 70 82 83  84 75 77 72 63 59 1 0 0 0  0


0 -1 -2 -3 -4 -5 15 48 55 60  56 53 47 40 35  1  0  0  0  0   0  0  0  0  0  5 67 72 79 81  80 79 78 76 73 65 62  5  0  0  0
0 -1 -2 -3 -4  5 45 55 60 65  60 55 50 45 15  0  0  0  0  0   0  0  0  0  5 65 71 75 78 79  78 77 74 72 70 64 58 45  0  0  0
0 -1 -2 -3  5 25 55 60 65 70  65 60 55 48  5  0  0  0  0  0   0  0  0  5 55 63 68 72 71 68  65 68 73 70 65 60 55 50  5  0  0
0 -1 -2  5 50 55 60 65 70 75  70 65 60 55 47  5  0  0  0  0   0  0  5 45 60 62 65 60 55 50  20 50 55 57 55 54 55 52 48  0  0
0 -1  5 50 55 65 65 70 75 75  75 69 65 60 55 45  5  0  0  0   0  0 35 50 54 60 55 50 45  0   0  5 44 49 52 55 54 52 48  1  0
0  5 50 60 65 70 75 75 75 75  75 71 65 60 55 50 45  5  0  0   0  0 40 49 55 50 45 40  5  0   0  0  5 52 54 56 57 56 54 51  0
0  5 65 70 75 75 75 75 75 75  75 75 70 65 60 55 50 45  5  0   0  0 47 50 49 40 35  5  0  0   0  0  0 55 57 59 60 59 57 54  0
0  5 65 70 75 75 75 75 75 75  75 75 75 70 65 60 55 50 45  0   0  0  0 47 46 40  5  0  0  0   0  0  5 60 64 65 64 60 59 55  0
0 55 60 65 70 75 75 75 75 75  75 75 75 75 70 65 60 55 48  5   0  0  0  0  0  0  0  0  0  0   5 70 69 69 70 67 64 63 60  1  0
0 50 55 63 75 77 75 75 75 75  75 75 75 75 72 68 63 58 51 45   5  0  0  0  0  0  0  5 10 70  74 73 72 71 71 70 67 64 60  0  0


0 40 50 71 79 77 75 72 70 65  70 75 75 74 70 65 60 53 46 40  47 55 60 65 70 75 75 75 75 75  75 75 74 73 72 72 69 64 57 0  0
0 45 55 65 78 79 77 70 65 65  65 70 72 68 63 58 55 47 42 46  59 63 68 72 77 80 80 79 79 79  78 78 77 76 75 72 67 59 51 0  0
0 40 60 69 81 82 78 70 65 60  60 60 60 58 55 53 47 43 50 60  68 70 76 79 84 85 85 83 83 83  84 83 82 79 76 70 62 52  1 0  0
0 35 50 70 84 85 84 75 65 60  55 53 50 49 48 45 42 47 55 68  74 77 83 85 90 90 90 87 87 86  87 84 83 78 72 65 54 41  0 0  0
0  0 40 74 85 86 87 78 75 68  49  1  1  1 30 39 47 55 60 65  80 84 90 90 95 95 95 91 91 89  88 85 79 73 66 57 44 30  0 0  0

0 0 40 80 90 92 90 85 80 70   1  0  0  0  1 45 55 60 70 75  85 90 95 95 99 99 99 95 95 92  89 86 73 67 58 47 33 17 0 0  0
0 0 35 80 91 93 94 90 80 70   1  0  0  0  0  1 55 65 75 80  90 95 99 99 99 99 99 99 96 93  90 87 65 58 48 35 18  1 0 0  0
0 0 30 75 85 95 95 95 85 75   1  0  0  0  0  1 50 75 90 94  96 97 95 95 95 99 95 90 82 80  75 70 63 46 34 18  1  0 0 0  0
0 0  5 45 80 92 96 96 96 90  85  1  1  1  1 55 75 95 95 96  95 90 90 90 90 90 85 80 70 71  63 54 45 34  1  0  0  0 0 0  0
0 0  0 35 70 85 95 96 96 95  95 90 85 80 70 75 95 95 96 95  90 87 86 84 83 80 75 70 57 59  55 46  1  0  0  0  0  0 0 0  0


0 0  0 15 50 80 85 90 95 95  95 95 95 95 95 95 95 95 95 90  85 81 79 74 62 56  1  0  0 38   0  0  0  0  0  0  0  0  0 0  0
0 0  0  0  5 61 79 85 90 95  99 99 99 99 99 99 99 90 85 80  75 62 50 39 29  1  0  0  0 35   0  0  0  0  0  0  0  0  0 0  0
0 0  0  0  0  1 85 89 92 95  98 99 99 98 98 97 95 90 82 79   1  1  1  0  0  0  0  0  0 32   0  0  0  0  0  0  0  0  0 0  0
0 0  0  0  0  0  1 90 93 94  97 98 97 96 93 90 87 84  1  1   0  0  0  0  0  0  0  0  0 30   0  0  0  0  0  0  0  0  0 0  0
0 0  0  0  0  0  1 92 94 96  97 96 94 91 83  1  1  1  0  0   0  0  0  0  0  0  0  0  0 29   0  0  0  0  0  0  0  0  0 0  0
0 0  0  0  0  0  1 92 94 95  96 95 93 89  1  0  0  0  0  0   0  0  1  1  1  1  1  1  1 27   4  3  2  1  1  1  0  0  0 0  0
0 0  0  0  0  0  1 92 93 94  95 94 92  1  0  0  0  0  0  1   1  1  1  2  2  2  2  2 24 25  23 18  3  2  2  1  1  0  0 0  0
0 0  0  0  0  0  1 92 93 94  93 91 85  1  0  0  0  1  1  1   2  2  2  2 14 14 17 20 22 23  24 22 20 19  3  2  1  0  0 0  0
0 0  0  0  0  0  1 92 92 93  92 90 86  1  0  0  1  1  2  2   2 11 12 13 15 16 17 18 20 22  23 23 22 19 13  2  1  1  0 0  0
0 0  0  0  0  1 90 91 92 91  91 90  1  0  0  0  1  2  2  9  11 12 13 14 15 15 16 17 18 19  21 22 23 21 17  3  2  1  0 0  0
0 0  0  0  0  1 89 90 91 90  89  1  1  0  0  1  2  6  7  9  11 12 13 14 14 14  2  1  1  0   0 18 22 24 22 18  2  1  1 0  0
0 0  0  0  1  1 88 89 90 89  88  1  0  0  1  1  2  7  8 10  11 12 13 13 14 14  2  1  0  0   0 19 23 25 23 19  3  2  1 0  0
0 0  0  1  1 87 88 89 88 88  87  1  0  0  1  2  2  8  9 10  11 12 13 14 15 15  2  1  0  0   1 16 22 25 26 24 20  2  1 1  0
0 0  1  1 86 87 88 88 87 84   1  1  0  0  1  2  8  9 10 10  11 12 13 14 15 16 17 18 19 21  22 23 24 26 27 25 21  3  2 1  0
0 0  1 84 86 87 87 86 84 80   1  0  0  0  1  2  9 10 10 10  10 12 13 15 16 16 17 19 21 23  24 26 27 28 28 26 22 14  2 1  0
0 1  1 84 86 86 85 83 79 75   1  0  0  0  1  2  8 10 10 10  10 12 13  4  6 15 16 18 20 21  23 24 26 27 29 27 23 15  2 1  0
0 1 81 82 84 85 84 82 78 66   1  0  0  0  1  2  2  9 10 10  10 11  2  2  1  1  1  1  1  1   1 21 25 28 30 28 24 16  2 1  0
0 1 81 82 84 84 82 81 77  1   0  0  0  0  1  1  2  9 11 11   4  2  2  1  1  0  0  0  0  0   0  1 25 29 31 29 25  2  1 1  0
0 1 81 82 83 83 81 76  1  0   0  0  0  0  0  1  2 10 12 13   2  1  1  1  0  0  0  0  0  0   0  0 26 30 32 30 26  1  1 0  0
0 1 80 81 82 81 80  1  0  0   0  0  0  0  0  1  2  2 14 15   6  1  0  0  0  0  1  1  1  0   0  0 27 31 33 31 27  1  0 0  0
0 1 79 80 81 80 79  1  0  0   0  0  0  0  0  1  1  2 15 16  18 06  1  0  0  1 28 28 28  1   0  0 28 32 34 32 28  1  0 0  0
0 0  1 79 80 79 77  1  0  0   0  0  0  0  0  0  1  2 17 18  20 22 24 26 28 29 30 30 30 28   0  0  1 29 33 35 33 29  1 0  0
0 0  1 77 78 79 77  1  0  0   0  0  0  0  0  0  1  2 19 20  21 23 23 27 29 30 30 30 30 28   0  0  0 30 34 36 35 33  1 0  0
0 0  1 76 77 78 76  1  0  0   0  0  0  0  0  0  0  0  0  0   0  0  0  1 29 30 31 30 30 29   1  0  0 31 35 37 36 33  1 1  0
0 0  1 75 76 77 75  1  0  0   0  0  0  0  0  0  0  0  0  0   0  0  0  0  1 30 32 34 33 33  31  0  0 31 35 37 38 36 32 1  0
0 0  1 74 75 76 75 74  1  1   1  1  1  1  1  1  0  0 48 47  47  0  0  0  0  0  1 36 35 35  33  0  0  1 33 37 39 37 33 1  0
0 1 73 74 75 74 73 72 69 66  65 63 63 62 62 59 55 54 53 52  52 51  0  0  0  0  0  1 38 39   1  0  0  0 34 38 40 38 34 1  0
0 1 72 73 74 73 72 70 68 67  66 64 64 64 62 60 58 57 56 55  55 54 50 48  1  0  0  0 40 39   0  0  0  1 39 40 41 39 35 1  0
0 1 72 72 73 73 72 70 68 68  68 66 65 65 62 61 60 59 58 57  57 56 54 52 48  0  0  1 44 43   1  0  1 37 41 42 40 36  1 0  0
0 1 70 71 71 72 71 70 69 68  68 67 66 65 63 62 61 57 56 56  58 57 56 54 52 47 46 45 45 44  45 41 37 41 42 43 41 37  1 0  0


0 1 70 69 70 71 71 71 70 69  68 66 65 64 61 60 58 53 52 53  56 55 54 55 54 51 50 48 46 45  43 44 40 43 44 43 40 32 1 0  0
0 1 69 68 69 69 70 69 69 68  67 65 63 61 57 56 54  1  1  1  52 51 50 52 52 53 52 51 48 47  46 46 44 45 44 42 39  1 0 0  0
0 0  1 67 67 68 68 67 67 66  65 63 59 57  1  1  1  0  0  0   1  1 46 45 48 51 50 50 49 48  48 47 46 44 43 41 35  1 0 0  0
0 0  0  1 66 65 65 64 64 63  62 60  1  1  0  0  0  0  0  0   0  0  0  1 41 47 46 46 47 47  46 45 44 40 41 35  1  0 0 0  0
0 0  0  0  0  1 61 60 60  1   1  1  0  0  0  0  0  0  0  0   0  0  0  0  0  1  1  1  1 43  42 41 40  1  1  1  0  0 0 0  0

0 0  0  0  0  0  1  1  1  0   0  0  0  0  0  0  0  0  0  0   0  0  0  0  0  0  0  0  0  1   1  1  1  0  0  0  0  0 0 0  0
`;
// y is zero by default, so last row (all zeros) doesn't need to be calculated.


AFRAME.registerGeometry('canyon-terrain', {
  schema: {
    spacing: {default: 10},
    sunPosition: {type: 'vec3', default: {x:-1.0, y:1.0, z:-1.0}}
  },

  init: function (data) {
    // Creates geometry.
    const geometry = new THREE.PlaneGeometry((X_POINTS - 1) * data.spacing, (Z_POINTS - 1) * data.spacing, X_POINTS - 1, Z_POINTS - 1);
    geometry.rotateX(-Math.PI / 2);

    // applies elevations
    const vertices = geometry.attributes.position.array;
    const floatPatt = /\s*\S+/y;
    let match;
    let v = 0;
    while (match = floatPatt.exec(terrainHeights)) {
      let height = parseFloat(match[0]);
      height = height * -2;
      if (height < 0) {
        height -= 100;
      }
      vertices[v * 3 + 1] = height;
      ++v;
    }


    const perlin = new ImprovedNoise();
    const SEED = Math.random() * 100;

    const intensityTweak = new Float32Array(X_POINTS * Z_POINTS);
    for (let i = 0; i < X_POINTS; ++i) {
      for (let j = 0; j < Z_POINTS; ++j) {
        if (i > 0 && i < X_POINTS - 1 && j > 0 && j < Z_POINTS -1) {   // doesn't tweak rim
          const v = i + j * X_POINTS;
          for (let scale = 20; scale > 1; --scale) {
            intensityTweak[v] += perlin.noise(i / scale, j / scale, SEED);
          }
          intensityTweak[v] /= 15;
        }
      }
    }

    geometry.setAttribute('intensityTweak', new THREE.BufferAttribute(intensityTweak, 1));

    // computes normals that are smooth for shallow angles
    this.geometry = toCreasedNormals(geometry, 0.45 * Math.PI);
    geometry.dispose();
  }
});
