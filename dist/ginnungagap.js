/*! For license information please see ginnungagap.js.LICENSE.txt */
(()=>{var t={861:()=>{window.requestIdleCallback=window.requestIdleCallback||function(t){return setTimeout((function(){var e=Date.now();t({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})}),1)},window.cancelIdleCallback=window.cancelIdleCallback||function(t){clearTimeout(t)}}},e={};function o(n){var i=e[n];if(void 0!==i)return i.exports;var l=e[n]={exports:{}};return t[n](l,l.exports,o),l.exports}(()=>{"use strict";function t(){screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape").then((t=>{console.log("screen orientation locked:",t)})).catch((t=>{console.warn("screen orientation didn't lock:",t)}))}function e(){return!(AFRAME.utils.device.isMobile()||AFRAME.utils.device.isMobileVR())}function n(){return AFRAME.utils.device.isMobile()&&!AFRAME.scenes[0].is("vr-mode")}function i(t,e,o){let n=t/180*Math.PI,i=o*Math.sin(n),l=o*Math.cos(n),r=e/180*Math.PI;return{x:l*Math.cos(r),y:i,z:-l*Math.sin(r)}}var l=null;if(document.addEventListener("visibilitychange",(()=>{l&&(document.hidden?l.pause():l.play())}),!1),document.monetization){function r(t){console.log("monetization started:",t)}function s(t){console.log("monetization stopped:",t)}document.monetization.addEventListener("monetizationstart",r),document.monetization.addEventListener("monetizationstop",s)}else console.log("no monetization API");o(861),AFRAME.registerState({initialState:{armatureEl:null,gliderEl:null,cameraEl:null,leftHandEl:null,rightHandEl:null,controllerConnections:{},isAnyPressedLeft:!1,isAnyPressedRight:!1,xSetting:0,zSetting:0,controlStickEl:null,controlNeutralHeight:.95,controlMode:"HEAD",controlSubmode:"NONE",time:0,difficulty:.6,gliderPosition:{x:-30,y:15,z:30},gliderPositionStart:{x:-30,y:15,z:30},gliderRotationX:0,gliderRotationY:-45,gliderRotationZ:0,gliderRotationYStart:-45,isFlying:!1,gliderSpeed:5,numYellowStars:Math.POSITIVE_INFINITY,stars:0,questComplete:!1,inventory:{},hudVisible:!0,hudAirspeedAngle:0,hudAirspeedColor:"forestgreen",controlsReminderDisplayed:!1,debug:!1},handlers:{setState:function(t,e){for(let o in e)"target"!==o&&(console.log("setting",o,e[o]),t[o]=e[o])},setArmatureEl:function(t,o){this.powerup=new Howl({src:["../assets/411460__inspectorj__power-up-bright-a.mp3"]}),console.log("hasNativeWebXRImplementation:",window.hasNativeWebXRImplementation),console.log("hasNativeWebVRImplementation:",window.hasNativeWebVRImplementation),console.log("isMobile:",AFRAME.utils.device.isMobile()),console.log("isMobileVR:",AFRAME.utils.device.isMobileVR()),t.armatureEl=o,t.gliderEl=o.querySelector("#glider"),t.cameraEl=o.querySelector("[camera]");let i=AFRAME.scenes[0].querySelector("a-dust");i&&requestIdleCallback((()=>{i.components.dust.setCamera(t.armatureEl)}));let r=t.armatureEl.querySelector("#body"),s=t.gliderEl.querySelector("#wing"),a=o.querySelector("#hud");this.adjustForMagicWindow(s),AFRAME.scenes[0].is("vr-mode")&&AFRAME.utils.device.checkHeadsetConnected()?(this.adjustHudForVR(a),t.difficulty=.75):(this.adjustHudForFlat(a),n()?t.difficulty=.6:t.difficulty=.5),AFRAME.scenes[0].addEventListener("enter-vr",(e=>{AFRAME.utils.device.checkHeadsetConnected()&&(r.object3D.position.y=-1.6,this.adjustHudForVR(a),this.adjustForMagicWindow(s),t.difficulty=.75),l&&!l.playing()&&l.play()})),AFRAME.scenes[0].addEventListener("exit-vr",(e=>{this.adjustHudForFlat(a),this.adjustForMagicWindow(s),n()?t.difficulty=.6:t.difficulty=.5})),e()&&!AFRAME.utils.device.checkHeadsetConnected()&&(console.log("desktop w/o headset; disabling look-controls so keyboard controls can function"),t.cameraEl.setAttribute("look-controls","enabled","false")),t.gliderEl.addEventListener("raycaster-intersection",(e=>{e.detail.intersections.length>0&&e.detail.intersections[0].distance>0&&(console.log("CRASH!",e.detail.els[0].tagName,e.detail.intersections[0].distance,t.gliderEl.getAttribute("raycaster").far,t.gliderSpeed/4),AFRAME.scenes[0].emit("hover",{}),new Howl({src:["../assets/198876__bone666138__crash.mp3"]}).play(),setTimeout((()=>{t.gliderSpeed>=30?(sessionStorage.setItem("returnWorld",location.pathname),location.assign("../ginnungagap/")):(t.gliderPosition.x=t.gliderPositionStart.x,t.gliderPosition.y=t.gliderPositionStart.y,t.gliderPosition.z=t.gliderPositionStart.z,t.gliderRotationX=0,t.gliderRotationY=t.gliderRotationYStart,t.gliderSpeed=5,this.controlStickToNeutral(t),t.hudAirspeedAngle=0,t.hudAirspeedColor="forestgreen",t.cameraEl.object3D.rotation.x=0,t.cameraEl.object3D.rotation.y=0,t.cameraEl.object3D.rotation.z=0,setTimeout(this.showControlsReminder.bind(this,t),3e3))}),2e3))})),o.addEventListener("hitstart",(e=>{e.detail.intersectedEls.forEach((e=>{if(e.classList.contains("powerup"))console.log("powerup"),t.gliderSpeed+=16,this.powerup.play();else if(e.classList.contains("star"))++t.stars,console.log("collected star",t.stars,"of",t.numYellowStars),e.parentNode.removeChild(e),this.ding.play();else if("key"===e.id)t.questComplete=!0,new Howl({src:["../assets/361684__taranp__horncall-strauss1-eflatmajor_incipit.mp3"]}).play(),e.parentNode.removeChild(e);else if(e.classList.contains("proximitySound")){let t=e.getAttribute("data-sound-url"),o=e.getAttribute("data-sound-volume")||1;t&&new Howl({src:t,volume:o,autoplay:!0});let n=e.getAttribute("data-text"),i=AFRAME.scenes[0].querySelector("#subtitle");n&&i&&(i.setAttribute("value",n),setTimeout((()=>{i.setAttribute("value","")}),5e3))}else e.components.link&&(console.log("hit link"),/ginnungagap/.test(location.pathname)||sessionStorage.setItem("previousWorld",location.pathname))}))})),document.addEventListener("keydown",(function(e){switch(t.cameraEl.getAttribute("rotation"),e.code){case"KeyA":case"ArrowLeft":t.cameraEl.object3D.rotation.z+=.07;break;case"KeyD":case"ArrowRight":t.cameraEl.object3D.rotation.z-=.07;break;case"KeyW":case"ArrowUp":t.cameraEl.object3D.rotation.x+=.045;break;case"KeyS":case"ArrowDown":t.cameraEl.object3D.rotation.x-=.045;break;case"Space":t.isFlying?t.debug&&AFRAME.scenes[0].emit("hover",e):AFRAME.scenes[0].emit("launch",e);break;case"Enter":t.hudVisible=!t.hudVisible}}),!1),t.leftHandEl=document.getElementById("leftHand"),t.rightHandEl=document.getElementById("rightHand"),e()&&(t.leftHandEl.setAttribute("hand-controls","handModelStyle","highPoly"),t.rightHandEl.setAttribute("hand-controls","handModelStyle","highPoly")),this.leftDownHandler=this.handHandler.bind(this,"LEFT","DOWN",t),this.leftUpHandler=this.handHandler.bind(this,"LEFT","UP",t),this.rightDownHandler=this.handHandler.bind(this,"RIGHT","DOWN",t),this.rightUpHandler=this.handHandler.bind(this,"RIGHT","UP",t),t.controlStickEl=document.getElementById("controlStick")},controllerconnected:function(t,e){t.controllerConnections[e.component.el.id]=!0,this.adjustControlMode(t)},controllerdisconnected:function(t,e){t.controllerConnections[e.component.el.id]=!1,this.adjustControlMode(t)},adjustControlMode:function(t){const e=t.controlMode;t.controllerConnections.leftHand||t.controllerConnections.rightHand?t.controlMode="HANDS":t.controlMode="HEAD",t.controlMode!==e&&(console.log("changed control mode from",e,"to",t.controlMode),"HANDS"===t.controlMode?(t.leftHandEl?.addEventListener("buttondown",this.leftDownHandler),t.leftHandEl?.addEventListener("buttonup",this.leftUpHandler),t.rightHandEl?.addEventListener("buttondown",this.rightDownHandler),t.rightHandEl?.addEventListener("buttonup",this.rightUpHandler),this.controlStickToNeutral(t),t.controlStickEl.object3D.visible=!0):"HEAD"===t.controlMode&&(t.leftHandEl?.removeEventListener("buttondown",this.leftDownHandler),t.leftHandEl?.removeEventListener("buttonup",this.leftUpHandler),t.rightHandEl?.removeEventListener("buttondown",this.rightDownHandler),t.rightHandEl?.removeEventListener("buttonup",this.rightUpHandler),t.controlStickEl.object3D.visible=!1))},handHandler:function(t,e,o,n){const i=o.isAnyPressedLeft,l=o.leftHandEl?.components["tracked-controls"],r=l&&l.controller&&l.controller.gamepad&&l.controller.gamepad.buttons;if(r){o.isAnyPressedLeft=!1;for(let t=0;t<r.length;++t)r[t].pressed&&(o.isAnyPressedLeft=!0)}else"LEFT"===t&&(o.isAnyPressedLeft="DOWN"===e);const s=o.isAnyPressedRight,a=o.rightHandEl?.components["tracked-controls"],c=a&&a.controller&&a.controller.gamepad&&a.controller.gamepad.buttons;if(c){o.isAnyPressedRight=!1;for(let t=0;t<c.length;++t)c[t].pressed&&(o.isAnyPressedRight=!0)}else"RIGHT"===t&&(o.isAnyPressedRight="DOWN"===e);if(o.isAnyPressedLeft&&!i)switch(o.controlSubmode){case"LEFT":o.controlSubmode="NONE";break;case"RIGHT":case"NONE":o.controlSubmode="LEFT"}else if(o.isAnyPressedRight&&!s)switch(o.controlSubmode){case"RIGHT":o.controlSubmode="NONE";break;case"LEFT":case"NONE":o.controlSubmode="RIGHT"}console.log("controlSubmode:",o.controlSubmode)},controlStickToNeutral:function(t){if(t.controlStickEl){const e=t.cameraEl.getAttribute("position");t.controlNeutralHeight=e.y-.56,t.controlStickEl.setAttribute("position",{x:0,y:t.controlNeutralHeight,z:-.4}),t.controlStickEl.setAttribute("rotation",{x:0,y:0,z:0}),t.xSetting=0,t.zSetting=0}},buttondown:function(t,e){t.isFlying?t.debug&&AFRAME.scenes[0].emit("hover",e):AFRAME.scenes[0].emit("launch",e)},countYellowStars:function(t,e){t.numYellowStars=AFRAME.scenes[0].querySelectorAll(".star").length,console.log("numYellowStars:",t.numYellowStars),t.numYellowStars&&(this.ding=new Howl({src:["../assets/393633__daronoxus__ding.mp3"]}))},launch:function(e,o){console.log("launch",o),e.isFlying=!0,e.controlsReminderDisplayed=!1;let i=AFRAME.scenes[0].querySelector("#prelaunchHelp");i&&i.setAttribute("value",""),function(){if(!n())return;let e,o=document.querySelector("canvas.a-canvas"),i=o.requestFullscreen||o.webkitRequestFullscreen||o.mozRequestFullScreen||o.msRequestFullscreen;i&&(e=i.apply(o)),e&&e.then||(e=Promise.resolve()),e.then(t,t)}();let l=AFRAME.scenes[0].querySelector("#postlaunchHelp");if(l&&l.src){let t=new Howl({src:[l.src]});setTimeout((()=>{t.play()}),6e4)}},hover:function(t,e){console.log("hover",e),t.isFlying=!1},loaded:function(t,e){document.getElementById("intro")||this.startInteraction(t)},"enter-vr":function(t){this.startInteraction(t)},"exit-vr":function(t,e){t.controlsReminderDisplayed&&this.showControlsReminder(t),document.getElementById("intro")&&AFRAME.scenes[0].emit("hover",e)},startInteraction:function(t){t.controlsReminderDisplayed?this.showControlsReminder(t):setTimeout(this.showControlsReminder.bind(this,t),1e4)},showControlsReminder:function(t){let e=AFRAME.scenes[0].querySelector("#prelaunchHelp"),o=document.getElementById("intro");!e||o&&!AFRAME.scenes[0].is("vr-mode")||t.isFlying||(t.controlsReminderDisplayed=!0,AFRAME.scenes[0].is("vr-mode")&&AFRAME.utils.device.checkHeadsetConnected()||AFRAME.utils.device.isMobileVR()?e.setAttribute("value","The wing above you\npoints where you're flying.\n\nTilt left: turn left\nTilt right: turn right\nTilt back: climb & slow down\nTilt forward: dive & speed up\nTrigger, button or touchpad: launch"):AFRAME.utils.device.isMobile()?e.setAttribute("value","The wing above you\npoints where you're flying.\n\nRoll your device left: turn left\nRoll your device right: turn right\nTilt up: climb & slow down\nTilt down: dive & speed up\nTap screen: launch"):e.setAttribute("value","The wing above you\npoints where you're flying.\n\nA: turn left\nD: turn right\nW: climb (& slow down)\nS: dive (& speed up)\nSpace bar: launch"))},iterate:function(t,e){switch(e.timeDelta=Math.min(e.timeDelta,100),t.time+=e.timeDelta*t.difficulty,t.controlMode){case"HEAD":let e=t.cameraEl.getAttribute("rotation");if(!e)return void console.warn("camera rotation not available");let o=n()?e.x+20:e.x;t.xSetting=o,t.zSetting=e.z;break;case"HANDS":const i=t.leftHandEl?.getAttribute("position"),l=t.rightHandEl?.getAttribute("position");switch(t.controlSubmode){case"LEFT":const e=t.leftHandEl?.getAttribute("rotation");t.controlStickEl.setAttribute("position",i),t.controlStickEl.setAttribute("rotation",e),t.xSetting=e.x,t.zSetting=e.z;break;case"RIGHT":const o=t.rightHandEl?.getAttribute("rotation");t.controlStickEl.setAttribute("position",l),t.controlStickEl.setAttribute("rotation",o),t.xSetting=o.x,t.zSetting=o.z}}let o=t.xSetting-t.gliderRotationX,l=(o+15*Math.sign(o))*(e.timeDelta/1e3);Math.abs(l)>Math.abs(o)&&(l=o);let r=t.gliderRotationX+l;r=Math.max(r,-75),r=Math.min(r,75),t.gliderRotationX=r;let s=t.zSetting-t.gliderRotationZ,a=(s+15*Math.sign(s))*(e.timeDelta/1e3);Math.abs(a)>Math.abs(s)&&(a=s);let c=t.gliderRotationZ+a;c=Math.max(c,-70),c=Math.min(c,70),t.gliderRotationZ=c;let d=t.gliderRotationZ*e.timeDelta/1e3;if(t.gliderRotationY=(t.gliderRotationY+d+180)%360-180,t.isFlying){let o=t.gliderSpeed*e.timeDelta/1e3,n=i(t.gliderRotationX,t.gliderRotationY+90,o),l=n.y;t.gliderPosition.x+=n.x,t.gliderPosition.y+=l,t.gliderPosition.z+=n.z;let r=(-Math.sign(l)*Math.sqrt(19.614*Math.abs(l))-5e-4*t.gliderSpeed*t.gliderSpeed)*e.timeDelta/1e3;t.gliderSpeed=Math.max(t.gliderSpeed+r,.1),t.gliderSpeed=Math.min(t.gliderSpeed,99.4),t.hudAirspeedAngle=Math.min(9*t.gliderSpeed,359),t.hudAirspeedColor=t.gliderSpeed<30?"forestgreen":"goldenrod",t.gliderEl.setAttribute("raycaster","far",t.gliderSpeed/4)}},placeInGliderPath:function(t,e){let o=i(t.gliderRotationX+(Math.random()-.5)*e.variation,t.gliderRotationY+90+(Math.random()-.5)*e.variation,e.distance),n={x:t.gliderPosition.x+o.x,y:t.gliderPosition.y+o.y,z:t.gliderPosition.z+o.z};e.el.setAttribute("position",n),e.el.setAttribute("rotation","y",t.gliderRotationY)},adjustForMagicWindow:function(t){n()?(t.object3D.rotation.x=THREE.MathUtils.degToRad(-30),t.object3D.scale.set(1,1,3)):(t.object3D.rotation.x=0,t.object3D.scale.set(1,1,1))},adjustHudForVR:function(t){AFRAME.utils.device.isMobile()?(t.object3D.position.x=.3,t.object3D.position.y=.3):(t.object3D.position.x=.4,t.object3D.position.y=.42),t.object3D.rotation.x=THREE.MathUtils.degToRad(25),t.object3D.rotation.y=THREE.MathUtils.degToRad(-15)},adjustHudForFlat:function(t){e()?(t.object3D.position.x=.85,t.object3D.position.y=.45,t.object3D.rotation.x=0,t.object3D.rotation.y=0):(t.object3D.position.x=.7,t.object3D.position.y=.15,t.object3D.rotation.x=THREE.MathUtils.degToRad(15),t.object3D.rotation.y=THREE.MathUtils.degToRad(-20))}},computeState:function(t,e){try{!t.questComplete&&(t.questComplete=t.numYellowStars<=0||t.stars/t.numYellowStars>=.95,t.questComplete)&&new Howl({src:["../assets/361684__taranp__horncall-strauss1-eflatmajor_incipit.mp3"]}).play()}catch(t){console.error(t)}}}),AFRAME.registerComponent("armature-tick-state",{init:function(){AFRAME.scenes[0].emit("setArmatureEl",this.el)},tick:function(t,e){AFRAME.scenes[0].emit("iterate",{time:t,timeDelta:e})}}),AFRAME.registerComponent("ginnungagap",{init:function(){let t=this.el;if(l=new Howl({src:"100495__jakobthiesen__light-rain-in-forest.ogg",autoplay:!0,loop:!0,volume:1,html5:!1,onplayerror:function(){l.once("unlock",(function(){l.play()}))}}),e()){let e=document.createElement("a-entity");e.setAttribute("particle-system",{preset:"rain",particleCount:500}),e.setAttribute("bind__position","gliderPosition"),t.appendChild(e)}const o=e()?1200:300;this.clouds=[];let n=this.clouds;function i(e=900+300*Math.random(),i=80){n.length>=o&&t.components.pool__clouds.returnEntity(n.shift());let l=t.components.pool__clouds.requestEntity(!0),r=0;l.setAttribute("material","opacity",r);let s=setInterval((()=>{r+=1/2400,l.setAttribute("material","opacity",r),r>=.5&&clearInterval(s)}),16);AFRAME.scenes[0].emit("placeInGliderPath",{el:l,distance:e,variation:i}),l.object3D.rotation.z=2*Math.random()*Math.PI,n.push(l)}setTimeout((()=>{for(let t=Math.floor(.5*o);t>0;--t)i(200+1500*t/Math.floor(.5*o),270)}),4),setInterval(i,1e3),this.armaturePosition=document.getElementById("armature").object3D.position;var r=sessionStorage.getItem("returnWorld");if(r){var s=document.getElementById("returnPortal");s.setAttribute("link","href",r),s.setAttribute("link","image",r+"screenshot.png")}setInterval((()=>{let t=document.getElementById("returnPortal");t.setAttribute("visible","true"),AFRAME.scenes[0].emit("placeInGliderPath",{el:t,distance:100,variation:45})}),6e4)},play:function(){this.el.emit("launch","ginnungagap play")},tick:function(){this.clouds.forEach((t=>{if(this.armaturePosition.distanceTo(t.object3D.position)>150){let e=t.object3D.rotation.z;t.object3D.lookAt(this.armaturePosition),t.object3D.rotation.z=e}}))}})})()})();
//# sourceMappingURL=ginnungagap.js.map