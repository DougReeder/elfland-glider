<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ginnungagap - Elfland Glider</title>
    <meta name="description" content="Reflect on the choices that led you here">
    <meta http-equiv="origin-trial" data-feature="WebVR (For Chrome M62+)" data-expires="2018-06-20" content="AumwglYoLOmVMRC0kZEM0cBxsm6mKsLApNWTV6vt7MKepWAfnBWh9dQNlNxVCrdpFwH7OB2aSZJjpcrFhtYp+QMAAABZeyJvcmlnaW4iOiJodHRwczovL2RvdWdyZWVkZXIuZ2l0aHViLmlvOjQ0MyIsImZlYXR1cmUiOiJXZWJWUjEuMU02MiIsImV4cGlyeSI6MTUyOTQ2NjIwOH0=">
    <meta http-equiv="origin-trial" data-feature="WebVR (For Chrome M62+)" data-expires="2018-06-20" content="As9ETIc1e/OiSU8Ep7yF+k7s76kvumDKhG0A04zELfVXRb9A6sUejwmepb5QvzIRMJNILZstcXhwCtGhsR6lDAQAAABceyJvcmlnaW4iOiJodHRwczovL2VsZmxhbmQtZ2xpZGVyLnN1cmdlLnNoOjQ0MyIsImZlYXR1cmUiOiJXZWJWUjEuMU02MiIsImV4cGlyeSI6MTUyOTQ2NjIwOH0=">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.14/howler.core.min.js"></script>
    <!--<script src="../assets/aframe-master.min.js"></script>-->
    <script src="https://rawgit.com/aframevr/aframe/a1a142f/dist/aframe-master.min.js"></script>
    <script src="../assets/look-fly-controls.js"></script>
    <script src="https://cdn.rawgit.com/DougReeder/aframe-button-controls/v1.0.0/aframe-button-controls.js"></script>
    <script src="../assets/elfland-utils.js"></script>
    <script src="https://unpkg.com/aframe-state-component@^3.2.4/dist/aframe-state-component.min.js"></script>
    <script src="../assets/state.js"></script>
    <script src="https://unpkg.com/aframe-aabb-collider-component@^2.2.1/dist/aframe-aabb-collider-component.min.js"></script>

    <script src="https://unpkg.com/aframe-particle-system-component@1.0.x/dist/aframe-particle-system-component.min.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v3.13.1/dist/aframe-extras.primitives.min.js"></script>
    <script>
        AFRAME.registerComponent('ginnungagap', {
            init: function () {
                let sceneEl = this.el;

                this.rain = new Howl({
                    src: ['100495__jakobthiesen__light-rain-in-forest.ogg'],
                    autoplay: true,
                    loop: true,
                    volume: 1.0
                });
                // rain visual is too resource-intensive for mobile
                if (! AFRAME.utils.device.isMobile()) {
                    let rain = document.createElement('a-entity');
                    rain.setAttribute('particle-system', {preset: 'rain', particleCount: 500});
                    rain.setAttribute('bind__position', 'gliderPosition');
                    sceneEl.appendChild(rain);
                }

                let clouds = [];
                setTimeout(() => {
                    for (let i=0; i<1; ++i) {
                        placeCloud(i*100+75);
                    }
                }, 4);
                setInterval(placeCloud, 10000);
                function placeCloud(distance=200) {
                    if (clouds.length >= 10) {
                        sceneEl.components.pool__clouds.returnEntity(clouds.shift());
                    }

                    let cloudEl = sceneEl.components.pool__clouds.requestEntity(true);
                    let opacity=0;
                    cloudEl.setAttribute('material', 'opacity', opacity);
                    let intervalID = setInterval( () => {
                        opacity += 0.5 / 120;
                        cloudEl.setAttribute('material', 'opacity', opacity);
                        if (opacity >= 0.5) {
                            clearInterval(intervalID);
                        }
                    }, 16);
                    AFRAME.scenes[0].emit('placeInGliderPath', {el: cloudEl, distance: distance, variation:80});
                    clouds.push(cloudEl);
                }

                setInterval( () => {
                    let returnPortalEl = document.getElementById('returnPortal');
                    returnPortalEl.setAttribute('visible', 'true');
                    AFRAME.scenes[0].emit('placeInGliderPath', {el: returnPortalEl, distance: 100, variation:45});
                }, 60000);
            },

            play: function () {
                this.el.emit('launch', "ginnungagap play");
            }
        });
    </script>
</head>
<body>
<a-scene cursor="rayOrigin: mouse" ginnungagap pool__clouds="mixin:cloud; size:10; dynamic:true">
    <a-assets>
        <img id="cloudImg" crossorigin="anonymous"
             src="https://cdn.rawgit.com/IdeaSpaceVR/aframe-particle-system-component/master/dist/images/cloud.png">
        <a-mixin id="cloud" rotation="0 -45 0" geometry="primitive:plane; height:20; width:20"
                 material="side: double; shader:flat; transparent:true; alphaTest:0.0001; src:#cloudImg" scale="10 10 1"></a-mixin>
    </a-assets>

    <a-sky color="#616279"></a-sky>

    <a-entity id="returnPortal" position="0 15 -80" scale="5 5 0"
              link="href:../yggdrasil; on:hitstart; title:return; image:../yggdrasil/screenshot-yggdrasil.png;"
              visible="false"></a-entity>

    <a-entity id="armature" geometry="primitive: box; width: 2; height: 2; depth: 2" material="visible:false"
              bind__position="gliderPosition" bind__rotation.y="gliderRotationY" armature-tick-state
              aabb-collider="objects:[link]" >
        <a-entity id="glider" position="0 0 0" bind__rotation.x="gliderRotationX"
                  raycaster="objects:.landscape; far:0.5;">
            <a-entity id="headingTriangle" position="0 1.5 0"
                      geometry="primitive:triangle; vertexA:0 0 -4.25; vertexB:0.1 0 0; vertexC:-0.1 0 0;"
                      material="shader: flat; transparent:true; opacity:0.2; color:black;"></a-entity>
        </a-entity>
        <a-entity id="body">
            <a-entity camera="" look-fly-controls="">
                <a-text id="hud" position="0.2 0.42 -0.75" rotation="30 -20 0" width="2" align="center" value="HUD"
                        geometry="primitive:plane; width:0.14; height:0.1;"
                        material="color: gray; opacity: 0.7" bind__text="value: hudText" bind__visible="hudVisible"></a-text>
            </a-entity>
        </a-entity>
        <a-entity button-controls></a-entity>
    </a-entity>
</a-scene>
<!-- Copyright Â© 2018 P. Douglas Reeder; Licensed under the GNU GPL-3.0 -->
</body>
</html>
