<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>City - Elfland Glider</title>
    <meta name="description" content="More a technology test, than crafted game level.">
    <script src="../src/shim/requestIdleCallback.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.14/howler.core.min.js"></script>
    <script src="../src/aframe-master.min.js"></script>
    <script src="https://unpkg.com/aframe-look-controls-z@^1.0.0/look-controls-z.js"></script>
    <script src="https://unpkg.com/aframe-button-controls@^1.0.1/aframe-button-controls.js"></script>
    <script src="../assets/elfland-utils.js"></script>
    <script src="https://unpkg.com/aframe-state-component@^3.2.4/dist/aframe-state-component.min.js"></script>
    <script src="../assets/state.js"></script>
    <script src="https://unpkg.com/aframe-simple-sun-sky@^1.2.0/simple-sun-sky.js"></script>
    <!--<script src="https://unpkg.com/aframe-dust-component@^1.0.4/aframe-dust-component.js"></script>-->
    <script src="https://unpkg.com/aframe-aabb-collider-component@^2.2.1/dist/aframe-aabb-collider-component.min.js"></script>

    <script src="https://unpkg.com/aframe-shader-buildings@^0.7.0/dist/main.js"></script>
    <script src="https://unpkg.com/aframe-faceset-component@^0.4.1/dist/aframe-faceset-component.min.js"></script>
    <script src="../src/aframe-heightgrid-component.min.js"></script>
    <script src="../src/settlement-shader.js"></script>

    <script src="https://unpkg.com/aframe-glow@^1.0.1/dist/aframe-glow-component.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Niconne" rel="stylesheet">
    <script src="../assets/intro.js"></script>
    <script>
        const INITIAL_POSITION = {x:385, y:100, z:385};
        const INITIAL_ROTATION_X = 0;
        const INITIAL_ROTATION_Y = 45;
        const CITY_RADIUS_SQ = 921600;
        AFRAME.registerComponent('city', {
            init: function () {
                let sceneEl = this.el;
                sceneEl.emit('setState', {
                    gliderPositionStart: INITIAL_POSITION,
                    gliderPosition: {x: INITIAL_POSITION.x, y: INITIAL_POSITION.y, z: INITIAL_POSITION.z},
                    gliderRotationX: INITIAL_ROTATION_X,
                    gliderRotationY: INITIAL_ROTATION_Y,
                    gliderRotationYStart: INITIAL_ROTATION_Y
                });

                // sceneEl.emit('countYellowStars', {});


                fetch('terrain-heights-city.txt').then((response) => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        console.error("terrain-heights:", response);
                        return '0 2 1'
                    }
                }).then((text) => {
                    // console.log("heights:", text.split(/\s/));
                    let terrainEl = document.getElementById('terrain');
                    terrainEl.setAttribute('heightgrid', 'heights', text);
                });


                const numStyles = 6;
                let buildings = this.randomBuildings(numStyles);   // array of arrays

                let buildingEls = new Array(numStyles);

                buildingEls[0] = document.createElement('a-shader-buildings');
                buildingEls[0].setAttribute('wall-color', '#808080');

                buildingEls[1] = document.createElement('a-shader-buildings');
                buildingEls[1].setAttribute('x-proportion-geometry', 5);
                buildingEls[1].setAttribute('x-proportion-material', 5);
                buildingEls[1].setAttribute('z-proportion-geometry', 5);
                buildingEls[1].setAttribute('z-proportion-material', 5);
                buildingEls[1].setAttribute('y-proportion-geometry', 3.5);
                buildingEls[1].setAttribute('y-proportion-material', 3.5);
                buildingEls[1].setAttribute('window-width', -0.5);
                buildingEls[1].setAttribute('window-height', 0.0);
                buildingEls[1].setAttribute('wall-color', '#6e2b11');   // brick red

                buildingEls[2] = document.createElement('a-shader-buildings');
                buildingEls[2].setAttribute('x-proportion-geometry', 6);
                buildingEls[2].setAttribute('x-proportion-material', 6);
                buildingEls[2].setAttribute('z-proportion-geometry', 6);
                buildingEls[2].setAttribute('z-proportion-material', 6);
                buildingEls[2].setAttribute('y-proportion-geometry', 4.5);
                buildingEls[2].setAttribute('y-proportion-material', 4.5);
                buildingEls[2].setAttribute('window-width', -0.5);
                buildingEls[2].setAttribute('window-height', 0.3);
                buildingEls[2].setAttribute('wall-color', '#6e2b11');   // brick red

                buildingEls[3] = document.createElement('a-shader-buildings');
                buildingEls[3].setAttribute('x-proportion-geometry', 6);
                buildingEls[3].setAttribute('x-proportion-material', 6);
                buildingEls[3].setAttribute('z-proportion-geometry', 6);
                buildingEls[3].setAttribute('z-proportion-material', 6);
                buildingEls[3].setAttribute('y-proportion-geometry', 5.5);
                buildingEls[3].setAttribute('y-proportion-material', 5.5);
                buildingEls[3].setAttribute('window-width', 0.95);
                buildingEls[3].setAttribute('window-height', 0.0);
                buildingEls[3].setAttribute('wall-color', '#a0a0a0');   // light gray
                // buildingEls[3].setAttribute('wall-color', '#6e210b');   // brick red

                buildingEls[4] = document.createElement('a-shader-buildings');
                buildingEls[4].setAttribute('window-width', 0.8);
                buildingEls[4].setAttribute('window-height', -0.1);
                // buildingEls[4].setAttribute('wall-color', '#44cc88');

                buildingEls[5] = document.createElement('a-shader-buildings');
                buildingEls[5].setAttribute('y-proportion-geometry', 5);
                buildingEls[5].setAttribute('y-proportion-material', 5);
                buildingEls[5].setAttribute('window-width', 0.5);
                buildingEls[5].setAttribute('window-height', 0.0);
                buildingEls[5].setAttribute('wall-color', '#a5a696');

                for (let s=0; s<numStyles; ++s) {
                    buildingEls[s].setAttribute('sun-position', "-1 0.5 1");
                    buildingEls[s].setAttribute('buildings', JSON.stringify(buildings[s]));
                    buildingEls[s].classList.add('landscape');
                    sceneEl.appendChild(buildingEls[s]);
                }


                for (let p=0; p<4; ++p) {
                    let powerupEl = document.createElement('a-entity');
                    powerupEl.setAttribute('class', 'powerup');
                    powerupEl.setAttribute('position', this.randomIntersection());
                    powerupEl.setAttribute('geometry', {primitive:'triangle', vertexA:'-1.5 -1.5 -1.5', vertexB:'1.5 -1.5 1.5', vertexC:'1.5 1.5 -1.5'});
                    powerupEl.setAttribute('material', {visible:false});

                    let powerupInnerEl = document.createElement('a-icosahedron');
                    powerupInnerEl.setAttribute('material', {color:'#ff0000'});
                    powerupInnerEl.setAttribute('glow', {c: '0.2', color: '#ff0000', scale:'3.5'});

                    powerupEl.appendChild(powerupInnerEl);
                    sceneEl.appendChild(powerupEl);
                }

                let portalEl = document.createElement('a-entity');
                portalEl.setAttribute('id', 'nextQuestPortal');
                portalEl.setAttribute('position', this.randomIntersection());
                portalEl.setAttribute('scale', '5 5 0');
                portalEl.setAttribute('link', 'href:../yggdrasil; title:Elfland; image:../yggdrasil/screenshot.png; on:hitstart');
                sceneEl.appendChild(portalEl);


                // this.positionSph = new THREE.Spherical(1, Math.PI/2, 0);
                // this.position = new THREE.Vector3();
                // this.sss = document.querySelector('a-simple-sun-sky');
                // this.buildingEl = document.getElementById('terrain');
            },

            // tick: function (time) {
            //     this.positionSph.phi = Math.PI * (0.25 + 0.2 * Math.sin(Math.PI * (time / 120000 - 0.5)));
            //     this.positionSph.theta = Math.PI * time / 120000;
            //     this.position.setFromSpherical(this.positionSph);
            //     let positionStr = this.position.x + ' ' + this.position.y + ' ' + this.position.z;
            //     this.sss.setAttribute('sun-position', positionStr);
            //     // this.buildingEl.setAttribute('material', 'sunPosition', positionStr);
            // }

            randomBuildings: function (numStyles) {
                let buildings = new Array(numStyles);
                for (let s=0; s<numStyles; ++s) {
                    buildings[s] = [];
                }
                // increments x by the common multiple of x-proportion for building styles
                for (let i=0, x=-930; x <= 930; ++i, i%4 ? x+= 60 : x+=90) {
                    // increments z by the common multiple of z-proportion for building styles
                    for (let j=0, z=-930; z<=930; ++j, j%2 ? z+=60 : z+=90) {
                        if (Math.abs(x) <= 60 && Math.abs(z) <= 60) {
                            continue;
                        }

                        const MAX_HEIGHT_SQ = 36864;
                        const AVG_STORY = 5;

                        let xCoreSections = 1 + Math.floor(Math.random() * 5);
                        let xWingSections = Math.floor(Math.random() * 6);
                        let zCoreSections = 1 + Math.floor(Math.random() * 5);
                        let zWingSections = Math.floor(Math.random() * 6);

                        let maxStories = Math.sqrt((1 - x*x/CITY_RADIUS_SQ - z*z/CITY_RADIUS_SQ)*MAX_HEIGHT_SQ) / AVG_STORY;
                        if (isNaN(maxStories)) {
                            continue;
                        }
                        let ySections = Math.ceil((Math.exp(Math.random()) - 0.99999) * 20 * maxStories / 35) + Math.random() * 0.2;
                        if (ySections < 1) {
                            continue;
                        }

                        // sanity-checks proportions
                        if (xWingSections >= 2 && zCoreSections < 2) {
                            ++zCoreSections
                        }
                        if (zWingSections >= 2 && xCoreSections < 2) {
                            ++xCoreSections
                        }
                        if (ySections >= 2) {
                            while (xCoreSections + xWingSections < 2) {
                                ++xCoreSections;
                            }
                            while (zCoreSections + zWingSections < 2) {
                                ++zCoreSections;
                            }
                        }
                        if (ySections >= 10) {
                            while (zCoreSections + zWingSections < 3) {
                                ++zCoreSections;
                            }
                        }
                        if (ySections >= 20) {
                            while (xCoreSections + xWingSections < 3) {
                                ++xCoreSections;
                            }
                        }

                        let building = {
                            x: x,
                            z: z,
                            xCoreSections: xCoreSections,
                            xWingSections: xWingSections,
                            zCoreSections: zCoreSections,
                            zWingSections: zWingSections,
                            ySections: ySections,
                        };

                        let style = Math.floor(Math.random() * numStyles);
                        if (style < numStyles/2) {
                            // makes some walls blank (only works if windowWidth is not too great)
                            if (zCoreSections <= 2 && Math.random() < 0.3) {
                                building.xWingSections += 0.15;
                            } else if (xCoreSections <= 2 && Math.random() < 0.3) {
                                building.zWingSections += 0.15;
                            } else if (zCoreSections + zWingSections <= 4.5 && Math.random() < 0.1) {
                                building.xCoreSections += 0.15;
                            } else if (xCoreSections + xWingSections <= 4.5 && Math.random() < 0.1) {
                                building.zCoreSections += 0.15;
                            }
                        }
                        buildings[style].push(building);
                    }
                }
                return buildings;
            },

            randomIntersection: function () {
                let x, z;
                do {
                    x = -975 + Math.floor(Math.random() * 8) * 270;
                    z = -975 + Math.floor(Math.random() * 14) * 150;
                } while (x*x + z*z >= CITY_RADIUS_SQ);
                const y = 10;
                return x + ' ' + y + ' ' + z;
            }
        });
    </script>
</head>
<body>
<a-scene city cursor="rayOrigin: mouse">
    <a-assets>
        <a-asset-item id="dome-obj" src="dome.obj"></a-asset-item>
    </a-assets>

    <a-simple-sun-sky sun-position="-1 0.75 1" radius="7500"></a-simple-sun-sky>

    <a-entity id="terrain" material="shader:settlement; sunPosition:-1 0.75 1"
              heightgrid="origin:-3040 0 -2000; xdimension:13; zdimension:13; xspacing:333.333; zspacing:333.333;"
              class="landscape"></a-entity>

    <a-entity geometry="primitive:triangle; vertexA:-3040 0 -2000; vertexB:7483 0 -2000; vertexC:-3040 0 -7483"
              material="shader:settlement; sunPosition:-1 0.75 1" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:960 0 -2000; vertexB:960 0 7483; vertexC:7483 0 -2000"
              material="shader:settlement; sunPosition:-1 0.75 1" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:960 0 2000; vertexB:-7483 0 2000; vertexC:960 0 7483"
              material="shader:settlement; sunPosition:-1 0.75 1" class="landscape"></a-entity>
    <a-entity geometry="primitive:triangle; vertexA:-3040 0 2000; vertexB:-3040 0 -7483; vertexC:-7483 0 2000"
              material="shader:settlement; sunPosition:-1 0.75 1" class="landscape"></a-entity>

    <a-entity obj-model="obj:#dome-obj" material="shader:flat; color:#222; wireframe:true; side:back" class="landscape"
              position="0 0.1 0"></a-entity>

    <!--<a-dust num-points="192" dispersion="100" color="gray"></a-dust>-->


    <a-entity id="armature" geometry="primitive: box; width: 2; height: 2; depth: 2" material="visible:false"
              bind__position="gliderPosition" bind__rotation.y="gliderRotationY" armature-tick-state
              aabb-collider="objects:.powerup,.star,[link]" >
        <a-entity id="glider" position="0 0 0" bind__rotation.x="gliderRotationX"
                  raycaster="objects:.landscape; far:0.5;">
            <a-entity id="wing" position="0 1.5 0" bind__rotation.z="gliderRotationZ" material="visible:false">
                <a-plane rotation="90 0 0" position="0 -0.01 -1.54" height="5.35" width="0.05" color="black"></a-plane>
                <a-entity geometry="primitive:triangle; vertexA:0 0 -4.25; vertexB:7.65 0 3.4; vertexC:0 0 -3.4;"
                          material="shader: flat; transparent:true; opacity:0.5; color:black;"></a-entity>
                <a-entity geometry="primitive:triangle; vertexA:0 0 -4.25; vertexB:0 0 -3.4; vertexC:-7.65 0 3.4;"
                          material="shader: flat; transparent:true; opacity:0.5; color:black;"></a-entity>
                <a-entity geometry="primitive:triangle; vertexA:0 0 -3.4; vertexB:7.65 0 3.4; vertexC:0 0 1.133;"
                          material="shader: flat; transparent:true; opacity:0.5; color:white;"></a-entity>
                <a-entity geometry="primitive:triangle; vertexA:0 0 -3.4; vertexB:0 0 1.133; vertexC:-7.65 0 3.4;"
                          material="shader: flat; transparent:true; opacity:0.5; color:white;"></a-entity>
            </a-entity>
            <a-text id="hud" position="0.2 0.42 -0.75" rotation="30 -20 0" width="2" align="center" value="HUD"
                    geometry="primitive:plane; width:0.14; height:0.1;"
                    material="color: gray; opacity: 0.7" bind__text="value: hudText" bind__visible="hudVisible"></a-text>
        </a-entity>
        <a-entity id="body">
            <a-entity camera="far:15000" look-controls-z>
            </a-entity>
        </a-entity>
        <a-entity button-controls></a-entity>
        <a-text id="prelaunchHelp" position="0 0 -1" rotation="0 0 0" width="2" align="center" font="../assets/mozillavr.fnt" value="" visible="true"></a-text>
    </a-entity>
</a-scene>
</body>
</html>
<!-- Copyright © 2019 by P. Douglas Reeder; Licensed under the GNU GPL-3.0 -->
